<% transmitted_transitions = transitions.select { |t| t.to_state == "transmitted" } %>
<% if transitions.present? %>
  <% transitions.each do |transition| %>
    <% unless transmitted_transitions.include?(transition) && transition != transmitted_transitions.first %>
      <li role="listitem">
        <div class="timestamp"><%= timestamp transition.created_at %></div>
        <div class="status <%= transition.to_state %>"><%= transition.to_state.humanize %></div>
        <div class="details">
          <% if transition.initiated_by.present? %>
            <div>Initiated by: <%= transition.initiated_by.name_with_role %></div>
          <% end %>

          <% transition.efile_errors.each do |error| %>
            <div>
              <strong><%= "#{error.code}" if error.code.present? %></strong>
              <%= error.message %>
            </div>
          <% end %>

          <% if transition.to_state == "transmitted" %>
            <table>
              <tr>
                <th>date</th>
                <th>submission status</th>
              </tr>
              <% transmitted_transitions.each do |t| %>
                <% if t.metadata["raw_response"].present? %>
                  <% xml = Nokogiri::XML(t.metadata["raw_response"]) %>
                  <tr>
                    <td>
                      <%= xml.css("SubmsnStatusAcknowledgementDt").text.strip %>
                    </td>
                    <td>
                      <%= xml.css("SubmissionStatusTxt").text.strip %>
                    </td>
                  </tr>
                <% elsif t.metadata["receipt"] %>
                  <% xml = Nokogiri::XML(t.metadata["receipt"]) %>
                  <tr>
                    <td>
                      <%= xml.css("SubmissionReceivedTs").text.strip %>
                    </td>
                    <td>Submission received time</td>
                  </tr>
                <% end %>
              <% end %>
            </table>
          <% end %>

          <% if transition.metadata.present? %>
            <div class="accordion spacing-above-10">
              <a href="#" class="accordion__button" aria-expanded="true" aria-controls="a2">
                <h3>Details</h3>
              </a>
              <div class="accordion__content" id="a2">
              <pre>
                <code>
                  <% metadata = transition.to_state == "transmitted" ? transmitted_transitions.pluck(:metadata) : transition.metadata %>
                  <% metadata.each do |m| %>
                    <%= m %>
                  <% end %>
                </code>
              </pre>
              </div>
            </div>
          <% end %>
        </div>
      </li>
    <% end %>
  <% end %>
<% else %>
  <p>No logs yet</p>
<% end %>