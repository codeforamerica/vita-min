<% @main_heading = "StateFile Automated Messages" %>
<% content_for :page_title, @main_heading %>

<% content_for :card do %>
  <div class="slab">
    <div class="grid">
      <div class="grid__item width-one-whole">
        <div style="display: flex; align-items: center;">
          <h1 style="flex-grow: 1;"><%= @main_heading %></h1>
          <div>
            (<%= @intake.state_name %>, <%= @intake.locale.to_s %>, <%= @intake.email_address || @intake.phone_number %>)
          </div>
          <%= form_tag "", method: :get do %>
            <%= text_field_tag(:intake, params[:intake], placeholder: "Intake Id", style: "margin-left: 1rem;") %>
          <% end %>
        </div>

        <% @messages.each do |message_class| %>
          <div class="client-messages-container client-messages__email with-padding-med" style="background: #F7F7F7;">
            <div style="display:flex;">
              <div style="flex-grow:1;">
                <h1>
                  <%= message_class.name %>
                </h1>
              </div>
              <% if @intake.contact_preference.present? && @intake.contact_preference != "unfilled" %>
                <div>
                  <%= form_tag send_notification_hub_state_file_automated_messages_path(format: :js), remote: true do %>
                    <%= hidden_field_tag :message, message_class.name %>
                    <%= hidden_field_tag(:intake, "#{@intake.state_code}#{@intake.id}") %>
                    <%= submit_tag "Send #{@intake.contact_preference.capitalize}", class: "button button--cta" %>
                  <% end %>
                </div>
              <% end %>
            </div>
            <% @locales.each do |locale| %>
              <% email = email_message(message_class, locale) %>
              <div class="client-messages-container client-messages__email with-padding-med" style="background: #FFF;">
                <div style="display: flex;">
                  <div class="email__subject" style="flex-grow: 1;"><%= email.subject %></div>
                  <div><%= I18n.t("general.language_options.#{locale}") %></div>
                </div>
                <div style="display: flex;">
                  <div class="with-padding-med" style="display: inline-block; width: 60%; margin-right: 16px; z-index: 3;">
                    <%= content_tag :iframe, nil, style: "width: 100%", sandbox: "allow-same-origin allow-scripts", srcdoc: email.html_part.body.decoded %>
                  </div>
                  <% if message_class.respond_to?(:new) and message_class.new.respond_to?(:sms_body) %>
                    <div class="with-padding-med" style="display: inline-block; width: 35%; margin-right: 8px;">
                      <div class="client-messages__sms">
                        <div style="white-space: pre-line; overflow-x: auto;"><%= sms_body(message_class, locale) %></div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>

            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
<% content_for :script do %>
  <script>
      function resizeIFrameToFitContent( iFrame ) {
          iFrame.height = iFrame.contentWindow.document.body.scrollHeight + 20;
      }
      window.addEventListener("load", () => {
          document.querySelectorAll('iframe').forEach((iframe) => {
              if (iframe.contentDocument.readyState === 'complete') {
                  resizeIFrameToFitContent(iframe);
              } else {
                  iframe.onload = function () {
                      resizeIFrameToFitContent(iframe);
                  }
              }
          });
      });
  </script>
<% end %>