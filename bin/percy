#!/usr/bin/env ruby
APP_PATH = File.expand_path('../config/application', __dir__)
require_relative '../config/environment'

# path to your application root.
APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

FileUtils.chdir APP_ROOT do
  system!({ "PERCY_TOKEN" => Rails.application.credentials.percy_token },
    '
      if [ -z $PERCY_TOKEN ]; then echo "== ðŸš¨ Please download development.key to access PERCY_TOKEN =="; exit 1; fi

      if [ -z "$(git status --porcelain)" ]; then
        echo "== ðŸ“¸ Take baseline images =="
        git checkout main
        npx percy exec -- rspec --tag screenshot
        echo "== ðŸ“¸ Take new images =="
        git checkout -
        npx percy exec -- rspec --tag screenshot
      else
       echo "== ðŸš¨ Please commit changes first =="
       exit 1
      fi
    '
  )
end

