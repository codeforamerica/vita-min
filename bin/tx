#!/bin/bash
# This script uses pipx, which auto-installs Python packages from the Python package index
# as well as runs commands within them.
#
# It auto-detects possible problems where pipx isn't installed, and where the Transifex config
# file isn't present or has no API key stored in it.
#
# For all other situations of bad config, e.g. API key is invalid, we allow the Transifex client
# notice that and hopefully print an error message.
set -euo pipefail

# Ensure pipx is installed, so we can use it to install the Transifex CLI.
if ! which pipx > /dev/null ; then
  echo "E: pipx is required to run bin/tx"
  echo ""
  echo "To fix this, run brew bundle install"
  exit 1
fi

# Ensure Transifex credentials have been saved.
if ! [ -f "$HOME/.transifexrc" ] || ! grep -q password "$HOME/.transifexrc" ; then
  echo "W: You must configure transifex"
  echo ""
  echo "To fix this:"
  echo "- Visit https://www.transifex.com/user/settings/api/"
  echo "- Click 'Generate a token' at the top right"
  echo "- Copy the token to your clipboard"
  echo "- Run: bin/tx init --skipsetup --no-interactive --force-save --token {paste}"
  echo ""
fi

# Run transifex client via pipx, which makes sure a recent version is installed.
# `transifex-client` is the name of the package on the Python Package Index;
# `tx` is the name of the built-in command line app within that.
exec pipx run --spec transifex-client tx "$@"
